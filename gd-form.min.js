<script>
(function(){function e(e){return`$${(Math.round(100*e)/100).toLocaleString(void 0,{maximumFractionDigits:2})}`}function t(){const e=GD.byId("adsBody");if(!e||e.dataset.built==="1")return;e.innerHTML="";n.ads.forEach((t=>{const n=document.createElement("tr");n.dataset.id=t.id,n.innerHTML=`<td>${t.label}</td><td style="text-align:right">$${t.base.toLocaleString()}</td><td style="text-align:center"><input type="number" min="0" value="0" class="qty" style="width:80px"></td><td style="text-align:center"><label><input type="checkbox" class="opt-colour"> +$${t.colour}</label></td><td style="text-align:center"><label><input type="checkbox" class="opt-design"> +$${t.design}</label></td><td style="text-align:right" class="row-sub">$0</td>`,e.appendChild(n)})),e.dataset.built="1"}function o(){const o=GD.byId("gd-form");if(!o)return;const d=parseInt(GD.byId("qtyListings")?.value||"0",10),a=d*n.listing;GD.byId("subListings")&&(GD.byId("subListings").textContent=e(a));const l=parseInt(GD.byId("qtyOtherListings")?.value||"0",10),c=l*n.otherListing;GD.byId("subOtherListings")&&(GD.byId("subOtherListings").textContent=e(c));let s=0;Array.from(document.querySelectorAll("#adsBody tr")).forEach(((e,t)=>{const o=parseInt(e.querySelector(".qty")?.value||"0",10),d=e.querySelector(".opt-colour")?.checked?n.ads[t].colour:0,a=e.querySelector(".opt-design")?.checked?n.ads[t].design:0,l=o*(n.ads[t].base+d+a);e.querySelector(".row-sub")&&(e.querySelector(".row-sub").textContent=(0,window.String)?(e=>`$${(Math.round(100*e)/100).toLocaleString(void 0,{maximumFractionDigits:2})}`(l)):e(l)),s+=l}));const r=a+c+s,i=r*n.gstRate,u=r+i;GD.byId("subAds")&&(GD.byId("subAds").textContent=e(s)),GD.byId("subtotal")&&(GD.byId("subtotal").textContent=e(r)),GD.byId("gst")&&(GD.byId("gst").textContent=e(i)),GD.byId("grandTotal")&&(GD.byId("grandTotal").textContent=e(u));const m=GD.byId("grandTotalRaw");return m&&(m.value=String(Math.round(100*u))),{subListings:a,subOther:c,subAds:s,subtotal:r,gst:i,grand:u}}function d(){const e=GD.byId("submitBtn");if(!e)return;const t=GD.byId("status");e.addEventListener("click",(async()=>{t&&(t.textContent="");for(const e of["businessName","contactName","email","phone","cat1"]){const t=document.querySelector(`[name="${e}"]`);if(!t||!t.value.trim())return t?.focus(),void(t&&(t.textContent="Please fill all required fields.",t.style.color="#c00"))}const d=o(),a=Array.from(document.querySelectorAll("#adsBody tr")).map(((e,t)=>({size:n.ads[t].label,qty:parseInt(e.querySelector(".qty")?.value||"0",10),colour:!!e.querySelector(".opt-colour")?.checked,design:!!e.querySelector(".opt-design")?.checked}))),l={formType:"business",timestamp:(new Date).toISOString(),businessName:GD.$('[name="businessName"]')?.value.trim()||"",contactName:GD.$('[name="contactName"]')?.value.trim()||"",website:(GD.$('[name="website"]')?.value||"").trim(),email:GD.$('[name="email"]')?.value.trim()||"",phone:GD.$('[name="phone"]')?.value.trim()||"",address:(GD.$('[name="address"]')?.value||"").trim(),notes:(GD.$('[name="notes"]')?.value||"").trim(),category1:(GD.$('[name="cat1"]')?.value||"").trim(),category2:(GD.$('[name="cat2"]')?.value||"").trim(),category3:(GD.$('[name="cat3"]')?.value||"").trim(),qtyListings:parseInt(GD.byId("qtyListings")?.value||"0",10),qtyOtherListings:parseInt(GD.byId("qtyOtherListings")?.value||"0",10),subListings:d.subListings,subOtherListings:d.subOther,subAds:d.subAds,subtotal:d.subtotal,gst:d.gst,grandTotal:d.grand,ads:a};e.disabled=!0;const c=e.textContent;e.textContent="Submitting…",t&&(t.style.color="#666");try{await GD.post(l),e.textContent="✔ Order Submitted",e.classList.add("completed"),t&&(t.textContent="Your order was recorded. If you're paying online move to step 2.",t.style.color="#0a0"),GD.byId("stripePay")?.removeAttribute("disabled")}catch(o){console.error(o),e.disabled=!1,e.textContent=c||"Step 1: Place Your Order",t&&(t.textContent="Submission failed. Please try again or email us.",t.style.color="#c00")}}))}function a(){const e=GD.byId("stripePay");if(!e)return;const t=GD.byId("status");e.addEventListener("click",(async e=>{e.preventDefault();for(const e of["businessName","contactName","email","phone","cat1"]){const t=document.querySelector(`[name="${e}"]`);if(!t||!t.value.trim())return t?.focus(),void(t&&(t.textContent="Please fill all required fields first.",t.style.color="#c00"))}const n=GD.getGrandTotalCents();if(!n||n<50)return void(t&&(t.textContent="Please add at least one item before paying.",t.style.color="#c00"));e.target.disabled=!0;const o=e.target.textContent;e.target.textContent="Opening secure checkout…",t&&(t.textContent="Sending you to Stripe…",t.style.color="#666");try{const e=GD.$('[name="email"]')?.value?.trim()||"",o=GD.$('[name="businessName"]')?.value?.trim()||"",d=GD.$('[name="contactName"]')?.value?.trim()||"",a=GD.$('[name="phone"]')?.value?.trim()||"",l=await fetch(GD.CHECKOUT_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount_cents:n,currency:"cad",email:e,description:"Gabriola Directory — Listings & Ads",businessName:o,contactName:d,phone:a})}),c=await l.text();let s;try{s=JSON.parse(c)}catch(e){s={}}if(!l.ok||!s?.url)throw new Error(s?.error||c||"HTTP "+l.status);window.location.href=s.url}catch(n){console.error(n),t&&(t.textContent="Payment could not start. Please try again or contact us.",t.style.color="#c00"),e.target.disabled=!1,e.target.textContent=o||"Step 2: Complete Your Payment"}}))}const n={listing:60,otherListing:50,ads:[{id:"eighth",label:'⅛ page 2¾" × 2"',base:169,colour:30,design:60},{id:"quarter",label:'¼ page 2¾" × 4"',base:259,colour:60,design:90},{id:"quarterH",label:'¼ page horizontal 6" × 2"',base:269,colour:60,design:90},{id:"half",label:'½ page 6" × 4"',base:396,colour:86,design:100},{id:"full",label:'Full page 6" × 8½"',base:599,colour:110,design:150}],gstRate:.05};function l(){t();const e=GD.byId("gd-form");e&&(e.addEventListener("input",o),o()),d(),a()}if(window.GD)l();else{window.addEventListener("gd-ready",l,{once:!0});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t();new MutationObserver((()=>{const e=GD?.byId?.("adsBody");e&&e.dataset.built!=="1"&&t()})).observe(document.documentElement||document.body,{childList:!0,subtree:!0})}
})();
</script>